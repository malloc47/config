#!/bin/bash
set -e
E_BADARGS=65

cmd_help () {
    echo "Usage: `basename $0` [-o output-file] [-n hist-num] directory"
    exit $E_BADARGS
}

n=1
output=""

while getopts "hn:o:" opt; do
    case "$opt" in
	h) cmd_help;;
	n) n="$OPTARG";;
	o) output="$OPTARG";;
	[?]) cmd_help;;
    esac
done

np=$(($n + 1))
shift $(( OPTIND-1 ))
[ -z $1 ] && cmd_help
fullname=$(git ls-tree --name-only --full-name HEAD $1)
if [ -z $fullname ] ; then
    echo "$1 not a tracked file" 1>&2
    exit 1
fi
hash=$(git log --format=oneline $1 | head -$np | tail -n 1 | awk '{print $1}')
if [ -n $bash ] ; then
    if [ -z "$output" ]; then
	git show $hash:$fullname > $1
    else
	git show $hash:$fullname > $output
    fi
else
    echo "no history found for $1" 1>&2
    exit 1
fi

